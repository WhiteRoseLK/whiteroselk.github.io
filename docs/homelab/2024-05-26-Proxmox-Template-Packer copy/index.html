<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-homelab/2024-05-26-Proxmox-Template-Packer copy" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Proxmox, crÃ©ation d&#x27;un template packer | WhiteRose</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://WhiteRoseLK.github.io/docs/homelab/2024-05-26-Proxmox-Template-Packer copy"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Proxmox, crÃ©ation d&#x27;un template packer | WhiteRose"><meta data-rh="true" name="description" content="Le but de mon HomeLab est d&#x27;Ãªtre orientÃ© IaC et DevSecOps, le but est donc de configurer un maximum de choses de maniÃ¨re automatisÃ©e."><meta data-rh="true" property="og:description" content="Le but de mon HomeLab est d&#x27;Ãªtre orientÃ© IaC et DevSecOps, le but est donc de configurer un maximum de choses de maniÃ¨re automatisÃ©e."><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://WhiteRoseLK.github.io/docs/homelab/2024-05-26-Proxmox-Template-Packer copy"><link data-rh="true" rel="alternate" href="https://WhiteRoseLK.github.io/docs/homelab/2024-05-26-Proxmox-Template-Packer copy" hreflang="en"><link data-rh="true" rel="alternate" href="https://WhiteRoseLK.github.io/docs/homelab/2024-05-26-Proxmox-Template-Packer copy" hreflang="x-default"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.911bdd55.css">
<script src="/assets/js/runtime~main.3dc39156.js" defer="defer"></script>
<script src="/assets/js/main.aedac443.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/sticker.png" alt="WhiteRose" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/sticker.png" alt="WhiteRose" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">WhiteRose</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/projects/">Projects</a></div><div class="navbar__items navbar__items--right"><a href="https://evantay.com/pdf/resume.pdf" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" target="_self" href="/"><img src="/img/sticker.png" alt="WhiteRose" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/sticker.png" alt="WhiteRose" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b>WhiteRose</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">â–¶ Welcome</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/homelab/arr/">ğŸ”¬ HomeLab</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/homelab/arr/">ğŸ¿ La suite *arr</a><button aria-label="Expand sidebar category &#x27;ğŸ¿ La suite *arr&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/homelab/2024-05-25-Proxmox-Install">Proxmox: Installation de A Ã  Z</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/homelab/2024-05-26-Proxmox-Template-Packer copy">Proxmox, crÃ©ation d&#x27;un template packer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/homelab/2024-05-31-HomePage">HomePage dashboard</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/homelab/2024-05-31-PiHole">PiHole DNS et Ad block</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/formations/2024-09-09-HashiCorp-Vault">ğŸ§  Formation</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ğŸ”¬ HomeLab</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Proxmox, crÃ©ation d&#x27;un template packer</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Proxmox, crÃ©ation d&#x27;un template packer</h1></header><p>Le but de mon HomeLab est d&#x27;Ãªtre orientÃ© IaC et DevSecOps, le but est donc de configurer un maximum de choses de maniÃ¨re automatisÃ©e.
Pour cela je vais utiliser Packer, Terraform et Ansible. Dans ce guide je vais vous prÃ©senter comment automatiser la crÃ©ation d&#x27;un template Ubuntu sur Proxmox avec Packer.</p>
<p>Toute les commandes seront lancÃ©s depuis ma VM de dÃ©ploiement (Deploy) c&#x27;est Ã  partir d&#x27;elle que je vais ensuite dÃ©ployer le reste de mon Home-Lab.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="installation-packer-et-terraform">Installation packer et terraform<a href="#installation-packer-et-terraform" class="hash-link" aria-label="Direct link to Installation packer et terraform" title="Direct link to Installation packer et terraform">â€‹</a></h2>
<p>Pour installer packer et terraform voici les commandes :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">echo &quot;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main&quot; | sudo tee /etc/apt/sources.list.d/hashicorp.list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo apt update &amp;&amp; sudo apt install packer terraform</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>On peut vÃ©rifier l&#x27;installation de packer avec la commande :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">packer -v</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>On peut vÃ©rifier l&#x27;installation de terraform avec la commande :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">terraform -v</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="arborescence">Arborescence<a href="#arborescence" class="hash-link" aria-label="Direct link to Arborescence" title="Direct link to Arborescence">â€‹</a></h2>
<p>Je ne suis pas fan de tout mettre dans le mÃªme fichier c&#x27;est pourquoi j&#x27;utilise l&#x27;arborescence suivante :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">template-ubuntu-24.04/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”œâ”€â”€ packer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ build.pkr.hcl</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ http</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ meta-data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â””â”€â”€ user-data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ packer.pkr.hcl</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ source.pkr.hcl</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ variables.auto.pkrvars.hcl</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ variables.pkr.hcl</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â””â”€â”€ variables.pkrvars.hcl</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â””â”€â”€ terraform</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    â”œâ”€â”€ main.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    â”œâ”€â”€ modules</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    â”‚Â Â  â””â”€â”€ vm-test</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    â”‚Â Â      â”œâ”€â”€ main.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    â”‚Â Â      â”œâ”€â”€ terraform.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    â”‚Â Â      â””â”€â”€ variables.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    â”œâ”€â”€ module.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    â”œâ”€â”€ terraform.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    â”œâ”€â”€ terraform.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    â””â”€â”€ variables.tf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Le dossier racine <strong>template-ubuntu-24.04</strong> correspond au nom de la VM / du template.
Puis on retrouve les dossier <strong>packer</strong>, <strong>ansible</strong> ou <strong>terraform</strong> suivant la technologie utilisÃ©e.</p>
<p>Pour <strong>packer</strong>, on retrouve les fichiers habituels build, packer, source et variables.pkr.hcl
Le fichier variables.auto.pkrvars.hcl est automatiquement lu par packer lors du build et contient toute les variables non sensibles.
Le fichier variables.pkvars.hcl contient les variables sensibles (token, password, etc.)
Enfin le dossier http contient les fichiers nÃ©cessaires pour cloud-init.</p>
<p>Pour <strong>terraform</strong>, on retrouve les fichiers habituels main, terraform, module et variables.tf
Le fichier terraform.tfvars contient les variables spÃ©cifique Ã  notre projet.
Le dossier modules contient les ressources que l&#x27;on veut crÃ©er sÃ©parÃ©es par modules.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="token-api">Token API<a href="#token-api" class="hash-link" aria-label="Direct link to Token API" title="Direct link to Token API">â€‹</a></h2>
<p>Pour pouvoir utiliser packer pour communiquer avec Proxmox, il faut qu&#x27;il puisse s&#x27;y connecter. Pour cela, il est fortement recommandÃ© d&#x27;utiliser un token dÃ©diÃ© avec des permissions plus faibles que le compte root.</p>
<p>Pour crÃ©er ce token il suffit de suivre la mÃ©thode suivante :</p>
<p>Sur le Datacenter, je commence par crÃ©er un groupe. Cela me permettra de donner les mÃªmes permissions Ã  d&#x27;autres utilisateurs si nÃ©cessaires.
Mon groupe s&#x27;appel <strong>NodeAdmin</strong>. Je crÃ©e ensuite un utilisateur <strong>packer</strong> que je viens lier au groupe <strong>NodeAdmin</strong>.
Pour attribuer les permissions nÃ©cessaires Ã  packer, je rajouter dans l&#x27;onglet permissions une permission sur &quot;/&quot; attribuÃ©e au groupe <strong>NodeAdmin</strong> avec le rÃ´le <strong>Administrator</strong>.</p>
<p>Il ne reste plus qu&#x27;Ã  crÃ©er les tokens, pour cela dans l&#x27;onglet API Tokens, je crÃ©er un nouveau token pour le user packer que je nome deploy (le nom de la VM) et je dÃ©coche bien la case &quot;Privilege Separation&quot; afin que le token ai les mÃªmes droits que le user.</p>
<p>Le token devrait avoir des droits qui ressemblent Ã  cela :</p>
<p><img decoding="async" loading="lazy" alt="Token Rights" src="/assets/images/token-rights-packer-c550629d2c814f0941cc6faa4aa26993.png" width="1638" height="1236" class="img_ev3q"></p>
<p>J&#x27;en profite aussi pour crÃ©er un second token pour terraform.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="template-packer">Template Packer<a href="#template-packer" class="hash-link" aria-label="Direct link to Template Packer" title="Direct link to Template Packer">â€‹</a></h2>
<p>Le template packer que j&#x27;utilise est disponible <strong>ici</strong>. // TODO: Lien Github</p>
<p>Il utilise le plugin <a href="https://developer.hashicorp.com/packer/integrations/hashicorp/proxmox/latest/components/builder/iso" target="_blank" rel="noopener noreferrer">proxmox-iso</a> afin de construire un template packer Ã  partir d&#x27;un iso.</p>
<p>Pour l&#x27;utiliser, il suffit de le tÃ©lÃ©charger et de configurer les fichiers suivants :</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="variablesautopkrvarshcl">variables.auto.pkrvars.hcl<a href="#variablesautopkrvarshcl" class="hash-link" aria-label="Direct link to variables.auto.pkrvars.hcl" title="Direct link to variables.auto.pkrvars.hcl">â€‹</a></h3>
<p>Comme indiquÃ© plus haut, ce fichier contient les variables principales du fichier de config qui permettent de configurer le template :</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">proxmox_url = &quot;https://192.168.1.200:8006/api2/json&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">proxmox_username = &quot;packer@pam!deploy&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">proxmox_node = &quot;proxmox&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">template_cores = 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">template_disk_size = &quot;10G&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">template_memory_size = 2048</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">template_default_user = &quot;user&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">template_id = 998</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="variablespkrvarshcl">variables.pkrvars.hcl<a href="#variablespkrvarshcl" class="hash-link" aria-label="Direct link to variables.pkrvars.hcl" title="Direct link to variables.pkrvars.hcl">â€‹</a></h3>
<p>Ce fichier contient les variables sensibles. Pour ma part un token et le mot de passe SSH du template</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>Ce fichier contient des informations sensibles. Attention Ã  ne pas l&#x27;ajouter vos commits.</p></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">proxmox_token = &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">template_default_password = &quot;&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="deploy">Deploy<a href="#deploy" class="hash-link" aria-label="Direct link to Deploy" title="Direct link to Deploy">â€‹</a></h3>
<p>Pour valider les fichiers de configurations :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">packer validate -var-file=variables.pkrvars.hcl .</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Pour crÃ©er le template :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">packer build -var-file=variables.pkrvars.hcl .</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Si tout fonctionne, un template a du Ãªtre crÃ©Ã© sur proxmox.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="template-terraform">Template terraform<a href="#template-terraform" class="hash-link" aria-label="Direct link to Template terraform" title="Direct link to Template terraform">â€‹</a></h2>
<p>Maintenant que le template packer est prÃªt je vais me servir de terraform pour dÃ©ployer des VMs.</p>
<p>Pour cela j&#x27;utilise le provider proxmox de <a href="https://registry.terraform.io/providers/Telmate/proxmox/latest/docs" target="_blank" rel="noopener noreferrer">Telmate</a></p>
<p>Le template terraform que j&#x27;utilise est disponible <strong>ici</strong>. // TODO: Lien Github</p>
<p>Pour l&#x27;utiliser, il suffit de le tÃ©lÃ©charger et de configurer le fichier suivant :</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="terraformtfvars">terraform.tfvars<a href="#terraformtfvars" class="hash-link" aria-label="Direct link to terraform.tfvars" title="Direct link to terraform.tfvars">â€‹</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pm_api_url          = &quot;https://proxmox.home:8006/api2/json&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pm_api_token_id     = &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pm_api_token_secret = &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_name        = &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_target_node = &quot;proxmox&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_vmid        = 10</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_desc        = &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_onboot      = true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_startup     = &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_vm_state    = &quot;running&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_agent       = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_clone       = &quot;Template-Ubuntu-24.04&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_memory      = 2048</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_cores       = 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_size        = &quot;10G&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_storage     = &quot;SSD&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Le template terraform est prÃªt. Pour dÃ©ployer une VM il suffit de copier le template, de mettre Ã  jour le fichier terraform.tfvars puis de dÃ©ployer la VM avec les commandes :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">terraform plan</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">terraform apply</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/homelab/2024-05-25-Proxmox-Install"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Proxmox: Installation de A Ã  Z</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/homelab/2024-05-31-HomePage"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">HomePage dashboard</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#installation-packer-et-terraform" class="table-of-contents__link toc-highlight">Installation packer et terraform</a></li><li><a href="#arborescence" class="table-of-contents__link toc-highlight">Arborescence</a></li><li><a href="#token-api" class="table-of-contents__link toc-highlight">Token API</a></li><li><a href="#template-packer" class="table-of-contents__link toc-highlight">Template Packer</a><ul><li><a href="#variablesautopkrvarshcl" class="table-of-contents__link toc-highlight">variables.auto.pkrvars.hcl</a></li><li><a href="#variablespkrvarshcl" class="table-of-contents__link toc-highlight">variables.pkrvars.hcl</a></li><li><a href="#deploy" class="table-of-contents__link toc-highlight">Deploy</a></li></ul></li><li><a href="#template-terraform" class="table-of-contents__link toc-highlight">Template terraform</a><ul><li><a href="#terraformtfvars" class="table-of-contents__link toc-highlight">terraform.tfvars</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">RÃ©seaux</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/mathieu-bannwarth/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/WhiteRoseLK/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">DÃ©courvrir</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/projects">Projects</a></li><li class="footer__item"><a href="https://evantay.com/pdf/resume.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">DerniÃ¨re mise Ã  jour le Wed Dec 25 2024</div></div></div></footer></div>
</body>
</html>